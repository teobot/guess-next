import { useState, useEffect, createRef } from "react";

import Head from "next/head";

import ReactPlayer, { YouTubeConfig } from "react-player/youtube";

interface LevelDataClass {
  id: number;
  title: string;
  clipId: string;
  startAt: number;
  stopAt: number;
  continueFor: number;
  choices: {
    id: number;
    text: string;
    colour: string;
  }[];
  answer: number;
}

interface State {
  url: string;
  pip: boolean;
  playing: boolean;
  controls: boolean;
  light: boolean;
  volume: number;
  muted: boolean;
  played: number;
  loaded: number;
  duration: number;
  playbackRate: number;
  finished: boolean;
  hitStopAt: boolean;
  hasShownAfterChoice: boolean;
}

export default function Home({ levelData }: { levelData: LevelDataClass }) {
  const [domLoaded, setDomLoaded] = useState(false);
  const playerRef = createRef<ReactPlayer>();
  const [state, setState] = useState<State>({
    url: `https://www.youtube.com/watch?v=${levelData.clipId}`,
    pip: false,
    playing: false,
    controls: false,
    light: false,
    volume: 0,
    muted: false,
    played: 0,
    loaded: 0,
    duration: 0,
    playbackRate: 1.0,
    finished: false,
    hitStopAt: false,
    hasShownAfterChoice: false,
  });

  const youtubeConfig: YouTubeConfig = {
    playerVars: {
      autohide: 0,
      showinfo: 0,
      controls: 0,
      modestbranding: 1,
      rel: 0,
      disablekb: 1,
      iv_load_policy: 3,
      start: levelData.startAt,
      cc_load_policy: 0,
      fs: 0,
      playsinline: 1,
      enablejsapi: 1,
      origin: "http://localhost:3000",
      widgetId: 1,
    },
    embedOptions: {
      autoplay: 0,
    },
    onUnstarted: () => {
      console.log("onUnstarted");
    },
  };

  useEffect(() => {
    setDomLoaded(true);
  }, []);

  const handlePlay = () => {
    console.log("onPlay");
    setState({ ...state, playing: true });
  };

  const handlePause = () => {
    console.log("onPause");
    setState({ ...state, playing: false });
  };

  const handleEnded = () => {
    console.log("onEnd");
    setState({ ...state, finished: true });
  };

  const handleProgress = (v_state: any) => {
    console.log("onProgress", v_state);

    let stateToChange: State = {
      ...state,
    };

    if (v_state.playedSeconds >= levelData.stopAt) {
      if (!state.hitStopAt) {
        console.log("onPause");
        stateToChange.playing = false;
        stateToChange.hitStopAt = true;
      } else {
        if (v_state.playedSeconds >= levelData.stopAt + levelData.continueFor) {
          // its hit the stop at and the continue to time
          console.log("showAnswer");
          stateToChange.playing = false;
          stateToChange.finished = true;
          stateToChange.hasShownAfterChoice = true;
        }
      }
    }

    stateToChange.played = v_state.playedSeconds;

    setState(stateToChange);
  };

  const handleDuration = (duration: any) => {
    console.log("onDuration", duration);
    setState({ ...state, duration });
  };

  const handlePlayPause = () => {
    setState({ ...state, playing: !state.playing });
  };

  function convertHex(hexCode: string, opacity = 1) {
    let hex = hexCode.replace("#", "");

    if (hex.length === 3) {
      hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
    }

    let r = parseInt(hex.substring(0, 2), 16);
    let g = parseInt(hex.substring(2, 4), 16);
    let b = parseInt(hex.substring(4, 6), 16);

    /* Backward compatibility for whole number based opacity values. */
    if (opacity > 1 && opacity <= 100) {
      opacity = opacity / 100;
    }

    return "rgba(" + r + "," + g + "," + b + "," + opacity + ")";
  }

  const selectChoice = (id: number) => {
    console.log("selectChoice", id);
  };

  const OverlayContainer = ({
    children,
    top = 0,
    right = 0,
    bottom = 0,
    left = 0,
  }: {
    children: any;
    top?: number;
    right?: number;
    bottom?: number;
    left?: number;
  }) => {
    return (
      <div
        style={{
          position: "absolute",
          top: top,
          right: right,
          left: left,
          bottom: bottom,
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          zIndex: 100,
          width: "100%",
          height: "100%",
        }}
      >
        {children}
      </div>
    );
  };

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main
        style={{
          backgroundColor: "red",
          minHeight: "100vh",
          display: "flex",
          flexDirection: "column",
          justifyContent: "center",
          alignItems: "center",
        }}
      >
        <div
          style={{
            position: "relative",
            backgroundColor: "green",
            width: 1920 / 2,
            height: 1080 / 2,
            maxWidth: 1920 / 2,
            maxHeight: 1080 / 2,
            border: "6px solid blue",
          }}
        >
          <div
            style={{
              position: "absolute",
              top: 4,
              right: 4,
              bottom: 0,
              fontSize: 20,
              fontWeight: "bold",
              backgroundColor: "black",
              height: 30,
              display: "flex",
              justifyContent: "center",
              alignItems: "center",
            }}
          >
            {Math.round(state.played)} / {levelData.stopAt}
          </div>
          <OverlayContainer>
            {/* {!state.playing && !state.hitStopAt && (
              <button
                style={{
                  fontSize: 48,
                  fontWeight: "bold",
                }}
                onClick={handlePlayPause}
              >
                {state.playing ? "Pause" : "Play"}
              </button>
            )} */}
            {(!state.playing && state.hitStopAt) ||
              (true && (
                <>
                  {[1, 2].map((row) => {
                    return (
                      <div
                        key={"row_" + row}
                        style={{
                          width: "100%",
                          height: "100%",
                          display: "flex",
                          flexDirection: "column",
                        }}
                      >
                        {[1, 2].map((col) => {
                          const choice =
                            levelData.choices[(row - 1) * 2 + col - 1];
                          return (
                            <div
                              className="choice-container"
                              key={"col_" + choice.id}
                              style={{
                                width: "100%",
                                height: "100%",
                                backgroundColor: convertHex(
                                  choice.colour,
                                  0.25
                                ),
                                cursor: "pointer",
                              }}
                              onClick={() => selectChoice(choice.id)}
                            >
                              <div
                                style={{
                                  fontSize: 48,
                                  fontWeight: "bold",
                                  textAlign: "center",
                                }}
                              >
                                {choice.text}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                  <div
                    style={{
                      position: "absolute",
                      bottom: -50,
                      right: 0,
                      backgroundColor: "black",
                      padding: 10,
                    }}
                  >
                    Submit
                  </div>
                </>
              ))}
          </OverlayContainer>
          {domLoaded && (
            <>
              <ReactPlayer
                ref={playerRef}
                className="youtube-container"
                config={youtubeConfig}
                url={state.url}
                pip={state.pip}
                playing={state.playing}
                controls={state.controls}
                light={state.light}
                loop={false}
                playbackRate={state.playbackRate}
                volume={state.volume}
                muted={state.muted}
                onReady={() => console.log("onReady")}
                onStart={() => console.log("onStart")}
                onPlay={handlePlay}
                onPause={handlePause}
                onBuffer={() => console.log("onBuffer")}
                onSeek={(e) => console.log("onSeek", e)}
                onEnded={handleEnded}
                onError={(e) => console.log("onError", e)}
                onProgress={handleProgress}
                onDuration={handleDuration}
              />
              <div
                style={{
                  display: "flex",
                  width: "100%",
                }}
              >
                <code
                  style={{
                    color: "white",
                    fontSize: 20,
                    fontWeight: "bold",
                    textShadow: "0px 0px 10px black",
                    wordWrap: "break-word",
                    wordBreak: "break-all",
                  }}
                >
                  {JSON.stringify(state)}
                </code>
              </div>
            </>
          )}
        </div>
      </main>
    </>
  );
}

export async function getServerSideProps() {
  const levelData = {
    id: 1,
    title: "What does XQC say next?",
    clipId: "gHwkvZWzqyM",
    startAt: 0,
    stopAt: 5,
    continueFor: 9,
    choices: [
      {
        id: 1,
        text: "I'm a choice A",
        colour: "#ff0000",
      },
      {
        id: 2,
        text: "I'm a choice B",
        colour: "#0000ff",
      },
      {
        id: 3,
        text: "I'm a choice C",
        colour: "#00ff00",
      },
      {
        id: 4,
        text: "I'm a choice D",
        colour: "#ffff00",
      },
    ],
    answer: 1,
  } as LevelDataClass;
  return {
    props: {
      levelData,
    },
  };
}
